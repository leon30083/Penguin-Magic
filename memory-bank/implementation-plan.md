# Penguin-Magic 实施计划

> **项目名称**: 企鹅工坊二次开发
> **创建日期**: 2026-01-21
> **文档类型**: 实施计划（Implementation Plan）

---

## 说明

本文档包含一系列分步指令，指导 AI 开发者完成 Penguin-Magic 二次开发。

**重要**:
- 每一步要小而具体
- 每一步必须包含验证测试
- 严禁包含代码——只写清晰、具体的指令
- 先聚焦基础功能，完整功能后面再加

---

## 阶段 0: 环境准备

### 步骤 0.1: 确认项目结构

**指令**: 检查项目根目录，确认以下结构存在：
- `src/` 目录
- `src/components/nodes/` 目录
- `src/services/api/` 目录

**验证**: 运行 `ls src/components/nodes/` 和 `ls src/services/api/`，确认目录存在。

---

## 阶段 1: GLM 编程套餐接入（基础功能）

### 步骤 1.1: 创建 GLM API 服务

**指令**: 在 `src/services/api/` 目录下创建 `glm.ts` 文件。

**要求**:
- 使用 `@ai-sdk/openai-compatible` 创建 GLM 提供商
- 配置 Base URL 为 `https://open.bigmodel.cn/api/coding/paas/v4`
- 从环境变量读取 API Key
- 导出 `createGLMProvider` 函数
- 导出 `streamGLM` 函数（流式响应）
- 导出 `generateGLM` 函数（非流式响应）

**参考**: 查看 `.dev-docs/可能会用到的skill/glm-coding-skill/` 中的示例代码。

**验证**:
1. 文件创建成功
2. 导出的函数类型正确（TypeScript 无错误）

---

### 步骤 1.2: 添加环境变量配置

**指令**: 在项目根目录的 `.env.example` 文件中添加 GLM 相关环境变量。

**要求**:
- 添加 `GLM_API_KEY` 变量
- 添加 `GLM_BASE_URL` 变量
- 添加 `GLM_MODEL` 变量（默认值：glm-4.7）

**验证**: 打开 `.env.example` 文件，确认新变量已添加。

---

### 步骤 1.3: 创建 GLM LLM 节点

**指令**: 在 `src/components/nodes/llm/` 目录下创建 `glm.ts` 文件。

**要求**:
- 参考 `gemini.ts` 的结构
- 创建 `GLMNode` 组件
- 实现流式响应显示
- 实现多轮对话历史
- 添加中文注释

**验证**:
1. 文件创建成功
2. TypeScript 编译无错误
3. 组件结构符合 ComfyUI 节点规范

---

### 步骤 1.4: 注册 GLM 节点

**指令**: 在节点注册文件中添加 GLM 节点的注册。

**要求**:
- 找到节点注册文件（通常在 `src/index.ts` 或类似位置）
- 添加 GLM 节点的注册代码
- 节点类型命名为 `llm-glm`

**验证**: 搜索项目中所有节点注册代码，确认 GLM 节点已注册。

---

### 步骤 1.5: 测试 GLM Chat 基础功能

**指令**: 创建一个简单的测试，验证 GLM Chat 功能。

**测试内容**:
1. 发送 "你好" 消息
2. 验证响应内容不为空
3. 验证响应为中文
4. 验证流式响应正常

**验证**: 在开发环境中运行测试，确认所有测试通过。

---

## 阶段 2: 聚鑫平台 Sora-2-all 接入（基础功能）

### 步骤 2.1: 分析现有 Sora2 节点

**指令**: 阅读 `src/components/nodes/sora2/` 目录下的所有文件。

**要求**:
- 列出所有 8 个 Sora2 节点
- 分析每个节点的功能
- 分析 API 调用方式
- 分析双平台切换的实现方式

**验证**: 列出 8 个节点的名称和功能描述。

---

### 步骤 2.2: 创建聚鑫平台 API 服务

**指令**: 在 `src/services/api/` 目录下创建或修改 `juxin.ts` 文件。

**要求**:
- Base URL 配置为 `https://api.jxincm.cn`
- 实现创建视频 API（`POST /v1/video/create`）
- 实现查询任务 API（`GET /v1/video/query?id={taskId}`）
- 实现创建角色 API（`POST /sora/v1/characters`）
- 实现轮询策略（30 秒间隔）
- 实现 429 错误处理（自动重试）

**参考**: 查看 `.dev-docs/可能会用到的skill/juxin-platform.md` 中的 API 规范。

**验证**:
1. 文件创建成功
2. 导出的函数类型正确
3. 请求格式符合聚鑫平台规范

---

### 步骤 2.3: 修改 API 配置节点支持聚鑫平台

**指令**: 修改 `src/components/nodes/sora2/api-config.ts` 文件。

**要求**:
- 在平台选择下拉框中添加"聚鑫"选项
- 添加聚鑫平台的 API Key 输入框
- 保存聚鑫平台的配置

**验证**:
1. 打开 API 配置节点
2. 确认"聚鑫"选项出现
3. 确认可以保存聚鑫平台配置

---

### 步骤 2.4: 测试聚鑫平台文生视频功能

**指令**: 创建一个测试工作流，测试聚鑫平台文生视频功能。

**测试内容**:
1. 选择聚鑫平台
2. 输入测试提示词（如"一只猫在玩"）
3. 选择时长（10秒）
4. 选择比例（16:9）
5. 创建视频生成任务
6. 等待任务完成
7. 验证视频 URL 有效

**验证**: 在开发环境中运行测试，确认视频生成成功。

---

### 步骤 2.5: 测试聚鑫平台角色创建功能

**指令**: 创建一个测试工作流，测试聚鑫平台角色创建功能。

**测试内容**:
1. 生成一个视频（包含宠物）
2. 使用视频任务 ID 创建角色
3. 设置时间范围（如 "1,3"）
4. 验证角色创建成功
5. 记录角色 username

**验证**: 在开发环境中运行测试，确认角色创建成功。

---

### 步骤 2.6: 测试聚鑫平台角色引用功能

**指令**: 创建一个测试工作流，测试角色引用功能。

**测试内容**:
1. 使用步骤 2.5 创建的角色
2. 在新视频提示词中使用 `@username` 语法
3. 验证角色出现在新视频中
4. 验证角色外观一致

**验证**: 在开发环境中运行测试，确认角色引用成功。

---

## 阶段 3: 双平台切换验证

### 步骤 3.1: 测试贞贞平台功能（回归测试）

**指令**: 确认贞贞平台的所有功能仍然正常工作。

**测试内容**:
1. 文生视频功能
2. 图生视频功能
3. 角色创建功能
4. 角色引用功能

**验证**: 运行贞贞平台的所有测试，确认无回归。

---

### 步骤 3.2: 测试平台切换功能

**指令**: 测试在贞贞和聚鑫平台之间切换。

**测试内容**:
1. 在贞贞平台生成视频
2. 切换到聚鑫平台生成视频
3. 切换回贞贞平台生成视频
4. 验证平台切换无错误

**验证**: 运行平台切换测试，确认切换正常。

---

### 步骤 3.3: 测试角色跨平台通用

**指令**: 测试贞贞平台创建的角色在聚鑫平台可用。

**测试内容**:
1. 在贞贞平台创建角色
2. 切换到聚鑫平台
3. 在聚鑫平台使用该角色
4. 验证角色正常显示

**验证**: 运行跨平台角色测试，确认角色通用。

---

## 阶段 4: 完整功能测试

### 步骤 4.1: 端到端测试 GLM Chat

**指令**: 创建完整的 GLM Chat 工作流并测试。

**测试内容**:
1. 创建 GLM 节点
2. 发送多轮对话
3. 验证对话历史正确
4. 验证流式响应正常

**验证**: 运行完整测试，确认所有功能正常。

---

### 步骤 4.2: 端到端测试聚鑫平台

**指令**: 创建完整的聚鑫平台工作流并测试。

**测试内容**:
1. 配置聚鑫平台 API
2. 生成视频
3. 创建角色
4. 使用角色生成新视频
5. 批量生成多个视频

**验证**: 运行完整测试，确认所有功能正常。

---

### 步骤 4.3: 性能测试

**指令**: 测试关键功能的性能指标。

**测试内容**:
1. GLM Chat 首字响应时间（< 1 秒）
2. 视频生成时间（3-5 分钟）
3. 角色创建时间（< 5 秒）
4. API 调用响应时间（< 2 秒）

**验证**: 所有性能指标符合要求。

---

## 阶段 5: 文档更新

### 步骤 5.1: 更新 architecture.md

**指令**: 更新 `memory-bank/architecture.md` 文件。

**要求**:
- 添加 GLM 相关的模块说明
- 添加聚鑫平台相关的模块说明
- 更新目录结构
- 更新数据流图

**验证**: 打开 `architecture.md`，确认内容已更新。

---

### 步骤 5.2: 更新 progress.md

**指令**: 更新 `memory-bank/progress.md` 文件。

**要求**:
- 标记所有已完成的步骤
- 记录遇到的问题和解决方案
- 记录重要的技术决策

**验证**: 打开 `progress.md`，确认进度已更新。

---

## 注意事项

1. **必须完整阅读 memory-bank 中的所有文档**
2. **每完成一步验证后再进行下一步**
3. **遇到问题先提问，不要猜测**
4. **代码注释使用中文**
5. **保持模块化，禁止单体巨文件**

---

**文档版本**: v1.0
**创建日期**: 2026-01-21
**维护者**: Penguin-Magic 开发团队
