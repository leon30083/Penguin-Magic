# 03-ç™½æ¿åŒæ­¥æ£€æŸ¥æç¤ºè¯

> æ ¡éªŒç™½æ¿ä¸å®é™…ä»£ç çš„ä¸€è‡´æ€§

## ä½¿ç”¨åœºæ™¯

- PR/MR åˆå¹¶å‰æ£€æŸ¥ç™½æ¿æ˜¯å¦éœ€è¦æ›´æ–°
- å®šæœŸå®¡è®¡æ¶æ„æ–‡æ¡£å‡†ç¡®æ€§
- å‘ç°ä»£ç ä¸­çš„éšå¼ä¾èµ–

## æç¤ºè¯

```markdown
ä½ æ˜¯ä¸€ä¸ªä»£ç ä¸æ¶æ„ä¸€è‡´æ€§æ£€æŸ¥ä¸“å®¶ã€‚è¯·å¯¹æ¯”ä»¥ä¸‹ç™½æ¿å’Œä»£ç ï¼Œæ‰¾å‡ºä¸ä¸€è‡´ä¹‹å¤„ã€‚

## è¾“å…¥

Canvas ç™½æ¿ JSONï¼š
```json
{CANVAS_JSON}
```

é¡¹ç›®ä»£ç è·¯å¾„ï¼š{PROJECT_PATH}

## æ£€æŸ¥é¡¹

1. **èŠ‚ç‚¹å®Œæ•´æ€§**
   - ç™½æ¿ä¸­çš„èŠ‚ç‚¹æ˜¯å¦éƒ½æœ‰å¯¹åº”çš„ä»£ç æ–‡ä»¶/ç±»ï¼Ÿ
   - ä»£ç ä¸­æ˜¯å¦æœ‰ç™½æ¿æœªè®°å½•çš„é‡è¦æ¨¡å—ï¼Ÿ

2. **è¿çº¿å‡†ç¡®æ€§**
   - ç™½æ¿è¿çº¿æ˜¯å¦åæ˜ çœŸå®çš„ import/è°ƒç”¨å…³ç³»ï¼Ÿ
   - ä»£ç ä¸­æ˜¯å¦æœ‰ç™½æ¿æœªæ ‡æ³¨çš„ä¾èµ–ï¼Ÿ

3. **åˆ†ç»„æ­£ç¡®æ€§**
   - ç™½æ¿åˆ†ç»„æ˜¯å¦ä¸ç›®å½•ç»“æ„ä¸€è‡´ï¼Ÿ
   - æ˜¯å¦æœ‰è·¨åˆ†ç»„çš„å¼‚å¸¸ä¾èµ–ï¼Ÿ

## è¾“å‡ºæ ¼å¼

### ğŸ”´ ä¸¥é‡ä¸ä¸€è‡´ï¼ˆå¿…é¡»ä¿®å¤ï¼‰
| ç±»å‹ | ç™½æ¿ | ä»£ç  | å»ºè®® |
|:---|:---|:---|:---|
| ç¼ºå¤±èŠ‚ç‚¹ | - | UserService.py | æ·»åŠ åˆ°ç™½æ¿ |
| é”™è¯¯è¿çº¿ | Aâ†’B | Aä¸è°ƒç”¨B | åˆ é™¤è¿çº¿ |

### ğŸŸ¡ è½»å¾®ä¸ä¸€è‡´ï¼ˆå»ºè®®ä¿®å¤ï¼‰
| ç±»å‹ | ç™½æ¿ | ä»£ç  | å»ºè®® |
|:---|:---|:---|:---|
| å‘½åä¸ä¸€è‡´ | user_service | UserService | ç»Ÿä¸€å‘½å |

### ğŸŸ¢ ä¸€è‡´æ€§è‰¯å¥½
- èŠ‚ç‚¹è¦†ç›–ç‡ï¼š{X}%
- è¿çº¿å‡†ç¡®ç‡ï¼š{Y}%

### ğŸ“‹ ä¿®å¤å»ºè®®
1. {å…·ä½“ä¿®å¤æ­¥éª¤}
2. {å…·ä½“ä¿®å¤æ­¥éª¤}
```

## è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆå¯é€‰ï¼‰

```python
#!/usr/bin/env python3
"""
canvas_sync_check.py - ç™½æ¿ä¸ä»£ç ä¸€è‡´æ€§æ£€æŸ¥è„šæœ¬

ç”¨æ³•ï¼špython canvas_sync_check.py project.canvas /path/to/project
"""

import json
import ast
import os
from pathlib import Path

def load_canvas(canvas_path):
    with open(canvas_path) as f:
        return json.load(f)

def extract_imports(py_file):
    """æå– Python æ–‡ä»¶çš„ import å…³ç³»"""
    with open(py_file) as f:
        tree = ast.parse(f.read())
    imports = []
    for node in ast.walk(tree):
        if isinstance(node, ast.Import):
            for alias in node.names:
                imports.append(alias.name)
        elif isinstance(node, ast.ImportFrom):
            if node.module:
                imports.append(node.module)
    return imports

def check_consistency(canvas, project_path):
    """å¯¹æ¯”ç™½æ¿èŠ‚ç‚¹ä¸å®é™…æ–‡ä»¶"""
    canvas_nodes = {n['text'].split('\n')[0].strip('# ') 
                    for n in canvas.get('nodes', [])}
    
    actual_files = set()
    for py_file in Path(project_path).rglob('*.py'):
        actual_files.add(py_file.stem)
    
    missing_in_canvas = actual_files - canvas_nodes
    missing_in_code = canvas_nodes - actual_files
    
    return {
        'missing_in_canvas': missing_in_canvas,
        'missing_in_code': missing_in_code,
        'coverage': len(canvas_nodes & actual_files) / len(actual_files) * 100
    }

if __name__ == '__main__':
    import sys
    if len(sys.argv) != 3:
        print("ç”¨æ³•: python canvas_sync_check.py <canvas_file> <project_path>")
        sys.exit(1)
    
    canvas = load_canvas(sys.argv[1])
    result = check_consistency(canvas, sys.argv[2])
    
    print(f"è¦†ç›–ç‡: {result['coverage']:.1f}%")
    if result['missing_in_canvas']:
        print(f"ç™½æ¿ç¼ºå¤±: {result['missing_in_canvas']}")
    if result['missing_in_code']:
        print(f"ä»£ç ç¼ºå¤±: {result['missing_in_code']}")
```

## CI/CD é›†æˆ

```yaml
# .github/workflows/canvas-check.yml
name: Canvas Sync Check

on:
  pull_request:
    paths:
      - '**.py'
      - '**.canvas'

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check canvas consistency
        run: python scripts/canvas_sync_check.py docs/architecture.canvas src/
```
